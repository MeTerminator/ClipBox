<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MeT-Box</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white dark:bg-black text-black dark:text-white">
  <main class="flex min-h-screen flex-col items-center justify-between p-24">

    <div class="z-10 w-full max-w-5xl items-center justify-between font-mono text-sm lg:flex">
      <p class="fixed left-0 top-0 flex w-full justify-center border-b border-gray-300 
                 bg-gradient-to-b from-zinc-200 pb-6 pt-8 backdrop-blur-2xl dark:border-neutral-800 
                 dark:bg-zinc-800/30 dark:from-inherit lg:static lg:w-auto 
                 lg:rounded-xl lg:border lg:bg-gray-200 lg:p-4 lg:dark:bg-zinc-800/30">
        Sponsored by&nbsp;
        <a href="https://met6.top/" target="_blank" rel="noopener noreferrer">
          <code class="font-mono font-bold">Met6.top</code>
        </a>
      </p>

      <div class="fixed bottom-0 left-0 flex h-48 w-full items-end justify-center 
                  bg-gradient-to-t from-white via-white dark:from-black dark:via-black 
                  lg:static lg:h-auto lg:w-auto lg:bg-none">
        <a class="pointer-events-none flex place-items-center gap-2 p-8 
                  lg:pointer-events-auto lg:p-0"
           href="https://github.com/MeTerminator/met-box"
           target="_blank" rel="noopener noreferrer">
          By
          <img src="/vercel.svg" alt="Vercel Logo" class="dark:invert" width="100" height="24">
        </a>
      </div>
    </div>

    <div class="relative flex flex-col items-center place-items-center 
                before:absolute before:h-[300px] before:w-[480px] before:-translate-x-1/2 
                before:rounded-full before:bg-gradient-radial before:from-white 
                before:to-transparent before:blur-2xl before:content-[''] 
                after:absolute after:-z-20 after:h-[180px] after:w-[240px] 
                after:translate-x-1/3 after:bg-gradient-conic after:from-sky-200 
                after:via-blue-200 after:blur-2xl after:content-[''] 
                before:dark:bg-gradient-to-br before:dark:from-transparent 
                before:dark:to-blue-700 before:dark:opacity-10 
                after:dark:from-sky-900 after:dark:via-[#0141ff] after:dark:opacity-40 
                before:lg:h-[360px]">
      <p id="time" class="font-bold mb-5" style="font-size: 18vw;">00:00:00</p>
      <p id="exam-info" class="text-center" style="font-size: 3vw;"></p>
    </div>

    <div class="mb-32 grid text-center lg:mb-0 lg:grid-cols-4 lg:text-left"></div>
  </main>

  <script>
    const timeDisplay = document.getElementById('time');
    const examInfoDisplay = document.getElementById('exam-info');

    async function getNtpTime() {
      try {
        const response = await fetch('/api/ntptime/');
        const data = await response.json();
        return new Date(data.timestamp);
      } catch (error) {
        console.error('获取 NTP 时间失败，使用本地时间', error);
        return new Date();
      }
    }

    async function loadExams() {
      try {
        const response = await fetch('/api/exams/');
        return await response.json();
      } catch (error) {
        console.error('加载考试数据失败', error);
        return [];
      }
    }

    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
      const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
      const seconds = String(totalSeconds % 60).padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }

    async function startClock() {
      const exams = await loadExams();
      let ntpTime = await getNtpTime();

      function update() {
        ntpTime = new Date(ntpTime.getTime() + 1000);
        timeDisplay.textContent = ntpTime.toLocaleTimeString('zh-CN', { hour12: false }).padStart(8, '0');

        const nextExam = exams.find(exam => {
          const end = new Date(new Date(exam.start_at).getTime() + exam.duration_hour * 3600000);
          return ntpTime < end;
        });

        if (!nextExam) {
          examInfoDisplay.textContent = '';
          return;
        }

        const start = new Date(nextExam.start_at).getTime();
        const end = start + nextExam.duration_hour * 3600000;

        let info = '';
        if (ntpTime.getTime() < start) {
          info = `${nextExam.name} | 未开始 | 剩余 ${formatTime(start - ntpTime.getTime())}`;
        } else if (ntpTime.getTime() < end) {
          info = `${nextExam.name} | 考试中 | 已过去 ${formatTime(ntpTime.getTime() - start)} | 剩余 ${formatTime(end - ntpTime.getTime())}`;
        }

        examInfoDisplay.innerHTML = info
          .split('|')
          .map((s, i, a) => i < a.length - 1
            ? `${s}<span class="text-gray-500 mx-2">|</span>`
            : s)
          .join('');
      }

      update();
      setInterval(update, 1000);
    }

    startClock();
  </script>
</body>
</html>
